stages:
  - build
  - test
  - push
  - deploy

backend-build:
  stage: build
  script:
    - nix-build -A agora-backend
  tags:
    - shell-executor

backend-whitespace:
  stage: test
  script:
    - nix-build -A agora-backend-trailing-whitespace
  tags:
    - shell-executor

backend-haddock:
  stage: test
  script:
    - nix-build -A agora-backend-haddock
  tags:
    - shell-executor

frontend-build:
  stage: build
  script:
    - nix-build -A agora-frontend
  tags:
    - shell-executor

frontend-whitespace:
  stage: test
  script:
    - nix-build -A agora-frontend-trailing-whitespace
  tags:
    - shell-executor

backend-docker-image:
  stage: build
  script:
    - nix-build -A backend-image
  tags:
    - shell-executor

frontend-docker-image:
  stage: build
  script:
    - nix-build -A frontend-image
  tags:
    - shell-executor

backend-docker-image-push:
  stage: push
  script:
    - deployment/scripts/upload-image.sh backend
  tags:
    - shell-executor
  only:
    - master

frontend-docker-image-push:
  stage: push
  script:
    - deployment/scripts/upload-image.sh frontend
  tags:
    - shell-executor
  only:
    - master

staging-server-system:
  stage: build
  script:
    - nix-build -A staging-server
  tags:
    - shell-executor

staging-server-deploy:
  stage: deploy
  script:
    - nix-shell deployment/shell.nix --run deployment/scripts/deploy.sh
  tags:
    - shell-executor
  only:
    - master
